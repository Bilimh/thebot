<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Chatbot Orientation â€” LycÃ©e AimÃ© CÃ©saire</title>

  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(255, 255, 255, .06);
      --panel2: rgba(255, 255, 255, .08);
      --text: rgba(255, 255, 255, .92);
      --muted: rgba(255, 255, 255, .65);
      --accent: #7c3aed;
      --accent2: #22c55e;
      --danger: #ef4444;
      --shadow: 0 18px 60px rgba(0, 0, 0, .45);
      --radius: 18px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124, 58, 237, .35), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(34, 197, 94, .25), transparent 55%),
        radial-gradient(800px 700px at 40% 90%, rgba(59, 130, 246, .20), transparent 55%),
        linear-gradient(180deg, #070a14, #0b1020 60%, #070a14);
      display: block;
      /* important mobile */
      padding: 0;
    }

    /* App full screen (mobile like ChatGPT) */
    .app {
      width: 100%;
      height: 100dvh;
      overflow: hidden;
      display: grid;
      grid-template-rows: 64px 1fr auto;
      border: 0;
      border-radius: 0;
      box-shadow: none;
      background: linear-gradient(180deg, rgba(255, 255, 255, .07), rgba(255, 255, 255, .04));
    }

    /* Header sticky */
    header {
      position: sticky;
      top: 0;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, .10);
      backdrop-filter: blur(10px);
      background: rgba(10, 14, 28, .55);
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 0;
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255, 255, 255, .45), transparent 60%),
        linear-gradient(135deg, rgba(124, 58, 237, .95), rgba(34, 197, 94, .8));
      box-shadow: 0 10px 30px rgba(124, 58, 237, .22);
      flex: 0 0 auto;
    }

    .title {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
      min-width: 0;
    }

    .title strong {
      font-size: 14px;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title span {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chip {
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .05);
      color: var(--muted);
    }

    /* Main scroll area */
    main {
      padding: 16px;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-behavior: smooth;
      height: 100%;
      /* espace pour quick replies + input sticky */
      padding-bottom: 140px;
    }

    /* Messages container */
    .messages {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      margin: 0;
      max-width: none;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      width: 100%;
      animation: fadeIn .25s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .row.bot {
      justify-content: flex-start;
    }

    .row.user {
      justify-content: flex-end;
    }

    /* Avatar hidden on mobile (optionnel) */
    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .12);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex: 0 0 auto;
    }

    /* Bubble: full width on mobile */
    .bubble {
      width: 100%;
      max-width: 100%;
      padding: 12px 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      box-shadow: 0 10px 26px rgba(0, 0, 0, .16);
      line-height: 1.45;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .row.user .bubble {
      background: linear-gradient(135deg, rgba(124, 58, 237, .30), rgba(124, 58, 237, .16));
      border-color: rgba(124, 58, 237, .45);
    }

    .meta {
      font-size: 11px;
      color: rgba(255, 255, 255, .55);
      margin: 0 6px;
      white-space: nowrap;
      display: none;
    }

    /* Cards */
    .cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    @media (min-width:640px) {
      .cards {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
    }

    .card {
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .05);
      border-radius: 18px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform .2s ease, border-color .2s ease;
    }

    .card:hover {
      border-color: rgba(124, 58, 237, .4);
      transform: translateY(-2px);
    }

    .card h3 {
      margin: 0;
      font-size: 15px;
      letter-spacing: .2px;
      font-weight: 700;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      width: fit-content;
      color: var(--muted);
    }

    .card p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .card .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .link {
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      font-weight: 600;
      font-size: 12px;
      transition: all .2s ease;
    }

    .link:hover {
      background: rgba(255, 255, 255, .12);
      border-color: rgba(255, 255, 255, .25);
    }

    /* Quick replies + composer host (bottom area) */
    #composerHost {
      position: sticky;
      bottom: 0;
      z-index: 250;
      background: rgba(10, 14, 28, .75);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, .10);
    }

    .quick-replies {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      padding: 10px 14px 0 14px;
      max-width: 980px;
      margin: 0 auto;
    }

    .qr {
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 13px;
      transition: all .15s ease;
      user-select: none;
    }

    .qr:hover {
      background: rgba(255, 255, 255, .12);
      border-color: rgba(255, 255, 255, .25);
      transform: translateY(-1px);
    }

    .qr:active {
      transform: translateY(1px);
    }

    .qr.accent {
      border-color: rgba(124, 58, 237, .55);
      background: rgba(124, 58, 237, .2);
    }

    .qr.good {
      border-color: rgba(34, 197, 94, .55);
      background: rgba(34, 197, 94, .14);
    }

    .qr.warn {
      border-color: rgba(239, 68, 68, .55);
      background: rgba(239, 68, 68, .12);
    }

    /* Composer (text input) */
    .text-input-container {
      display: flex;
      gap: 10px;
      padding: 10px 14px 14px 14px;
      width: 100%;
      max-width: 980px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .text-input-container input {
      flex: 1;
      padding: 12px 18px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, .15);
      background: rgba(255, 255, 255, .07);
      color: white;
      font-size: 14px;
      outline: none;
      transition: all .2s ease;
    }

    .text-input-container input:focus {
      border-color: var(--accent);
      background: rgba(255, 255, 255, .10);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, .2);
    }

    .text-input-container input::placeholder {
      color: rgba(255, 255, 255, .5);
    }

    .text-input-container button {
      padding: 12px 18px;
      border-radius: 30px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #9f67ff);
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all .2s ease;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(124, 58, 237, .3);
    }

    .text-input-container button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(124, 58, 237, .4);
    }

    .text-input-container button:active {
      transform: translateY(1px);
    }

    /* Typing indicator */
    .typing {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: rgba(255, 255, 255, .65);
      animation: bounce 1s infinite ease-in-out;
    }

    .dot:nth-child(2) {
      animation-delay: .15s;
    }

    .dot:nth-child(3) {
      animation-delay: .30s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: translateY(0);
        opacity: .6;
      }

      40% {
        transform: translateY(-6px);
        opacity: 1;
      }
    }

    /* Links in header title */
    a {
      text-decoration: none;
      color: white;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, .03);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, .15);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, .25);
    }

    /* Desktop refinements */
    @media (min-width: 768px) {
      .messages {
        max-width: 820px;
        margin: 0 auto;
      }

      .bubble {
        width: auto;
        max-width: 75%;
      }

      .row.user .bubble {
        width: fit-content;
        max-width: 80%;
        margin-left: auto;
        /* pousse Ã  droite */
      }
    }

    /* Small screens tweaks */
    @media (max-width: 600px) {
      .chip {
        display: none;
      }

      main {
        padding: 14px;
        padding-bottom: 150px;
      }

      .text-input-container button {
        padding: 12px 16px;
      }

      .text-input-container input {
        font-size: 16px;
      }

      .row.user .bubble {
        width: fit-content;
        max-width: 80%;
        margin-left: auto;
        /* pousse Ã  droite */
      }
    }
  </style>
</head>

<body>
  <div class="app" role="application" aria-label="Chatbot orientation">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <strong><a href="https://bilimh.github.io/chatbot/">CÃ©saireGPT</a></strong>
          <span>DÃ©couvrir les mÃ©tiers et formations en 2 minutes</span>
        </div>
      </div>

      <div class="header-actions">
        <span class="chip" id="statusChip">PrÃªt</span>
        <span id="btnDemo" type="button" title="Mode dÃ©mo (auto)"></span>
      </div>
    </header>

    <!-- âœ… Zone scroll UNIQUEMENT pour les messages -->
    <main id="main">
      <div class="messages" id="messages"></div>
    </main>

    <!-- âœ… Zone fixe en bas : quick replies + input -->
    <div id="composerHost">
      <div id="quickReplies" class="quick-replies"></div>
      <!-- addTextInput() viendra ajouter .text-input-container ici -->
    </div>
  </div>
  <script>
    /* =========================
       0) SÃ©lecteurs DOM
       ========================= */
    const messagesEl = document.getElementById("messages");
    const quickRepliesEl = document.getElementById("quickReplies");
    const mainEl = document.getElementById("main");
    const statusChip = document.getElementById("statusChip");
    const btnRestart = document.getElementById("btnRestart");
    const btnDemo = document.getElementById("btnDemo");
  
    /* =========================
       1) CONTENU : formations
       ========================= */
    const PROGRAMS = {
      // ===== Initiale =====
      cap_elec: {
        title: "CAP Ã‰lectricien / Ã‰lectricienne",
        pitch: "Installer, entretenir et dÃ©panner des systÃ¨mes Ã©lectriques pour assurer lâ€™Ã©nergie et la sÃ©curitÃ© des bÃ¢timents.",
        duration: "2 ans",
        learn: ["Lire un plan", "Poser des cÃ¢bles", "Brancher", "RÃ©parer une panne"],
        jobs: ["Ã‰lectricien(ne)", "Monteur(se) Ã©lectricien(ne)", "Technicien(ne)"],
        next: "AprÃ¨s : Bac Pro MELEC possible.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/cap-electricien/",
        mode: "initiale",
        family: "Ã©lectricitÃ©",
      },
  
      bac_melec: {
        title: "Bac Pro MELEC",
        pitch: "Concevoir, installer et maintenir des systÃ¨mes Ã©lectriques performants pour les bÃ¢timents et les environnements connectÃ©s.",
        duration: "3 ans aprÃ¨s la 3e",
        learn: ["Installer", "Raccorder", "Tester / rÃ©gler", "Maintenance", "ConnectÃ©"],
        jobs: [
          "Technicien(ne) Ã©lectricien(ne)",
          "Ã‰lectricien(ne) qualifiÃ©(e)",
          "Installateur(trice) domotique",
        ],
        next: "AprÃ¨s : BTS possible.",
        pageUrl:
          "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-metier-de-lelectricite-et-de-ses-environnements-connectes/",
        mode: "initiale",
        family: "Ã©lectricitÃ©",
      },
  
      cap_metallier: {
        title: "CAP Serrurier / MÃ©tallier",
        pitch: "Concevoir, fabriquer et poser des Ã©lÃ©ments mÃ©talliques pour les bÃ¢timents et amÃ©nagements.",
        duration: "2 ans",
        learn: ["Lire un plan", "DÃ©couper", "Assembler / souder", "Poser"],
        jobs: ["MÃ©tallier(Ã¨re)", "Serrurier(Ã¨re)", "Monteur(se)"],
        next: "AprÃ¨s : Bac Pro MÃ©tallerie possible.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/cap-serrurier-metallier/",
        mode: "initiale",
        family: "bÃ¢timent",
      },
  
      bac_metallerie: {
        title: "Bac Pro MÃ©tallerie",
        pitch: "Fabriquer, assembler et poser des structures mÃ©talliques pour le bÃ¢timent (portes, garde-corps, escaliersâ€¦) en atelier et sur chantier.",
        duration: "3 ans aprÃ¨s la 3e",
        learn: ["PrÃ©parer un plan", "FaÃ§onner", "Assembler / souder", "Installer", "ContrÃ´ler"],
        jobs: ["MÃ©tallier(Ã¨re)", "Serrurier(Ã¨re)", "Charpentier(Ã¨re) mÃ©tal"],
        next: "AprÃ¨s : BTS possible.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-ouvrages-du-batiment-metallerie/",
        mode: "initiale",
        family: "bÃ¢timent",
      },
  
      cap_epc: {
        title: "CAP Ã‰quipier Polyvalent du Commerce",
        pitch: "Accueillir les clients, participer aux ventes et mettre en valeur les produits en magasin.",
        duration: "2 ans",
        learn: ["Accueillir", "Vendre / conseiller", "Mettre en rayon", "Encaisser"],
        jobs: ["EmployÃ©(e) de commerce", "Vendeur(se)", "Ã‰quipier(Ã¨re)"],
        next: "AprÃ¨s : Bac Pro Commerce/Vente possible.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/cap-equipier-polyvalent-du-commerce/",
        mode: "initiale",
        family: "commerce",
      },
  
      seconde_mrc: {
        title: "2nde Pro MRC",
        pitch: "DÃ©couvrir et apprendre les compÃ©tences clÃ©s du contact client, de la communication et du conseil en vente.",
        duration: "1 an",
        learn: ["Accueillir", "Conseiller", "Communiquer", "FidÃ©liser"],
        jobs: ["Conseiller(Ã¨re) clientÃ¨le", "Vendeur(se)", "Assistant(e) commercial(e)"],
        next: "AprÃ¨s : 1re Accueil ou Commerce/Vente.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/2nde-bac-pro-metiers-de-ma-relation-clientele-mrc/",
        mode: "initiale",
        family: "commerce",
      },
  
      bac_agora: {
        title: "2nde GATL â†’ Bac Pro AGOrA",
        pitch: "En 2nde, tu dÃ©couvres la Gestion, lâ€™Administration, le Transport et la Logistique (GATL). Ensuite, tu te spÃ©cialises en AGOrA (Assistance Ã  la Gestion des Organisations et de leurs ActivitÃ©s).",
        duration: "3 ans aprÃ¨s la 3e",
        learn: ["DÃ©couvrir GATL", "GÃ©rer des dossiers", "Outils numÃ©riques", "Organisation"],
        jobs: ["Assistant(e) administratif(ve)", "Agent de gestion", "EmployÃ©(e) logistique"],
        next: "AprÃ¨s la 2nde GATL : AGOrA (au lycÃ©e A. CÃ©saire).",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-gestion-administration-transport-logistique/",
        mode: "initiale",
        family: "gestion-administration",
      },
  
      bac_accueil: {
        title: "Bac Pro MÃ©tiers de l'Accueil",
        badge: "ðŸ™‚ Initiale â€” Accueil",
        pitch: "Accueillir, informer, orienter et gÃ©rer des situations usagers/clients en face Ã  face ou Ã  distance.",
        duration: "3 ans (entrÃ©e en 1re aprÃ¨s 2nde MRC ou GATL)",
        learn: ["Accueillir", "TÃ©lÃ©phone / mail", "Orienter", "GÃ©rer des situations"],
        jobs: ["Agent d'accueil", "ChargÃ©(e) d'accueil", "HÃ´te / HÃ´tesse"],
        next: "AprÃ¨s : BTS ou insertion pro.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-metiers-de-laccueil/",
        mode: "initiale",
        family: "tertiaire",
      },
  
      bac_commerce: {
        title: "Bac Pro MÃ©tiers du Commerce et de la Vente",
        badge: "ðŸ›ï¸ Initiale â€” Commerce",
        pitch: "Conseiller, vendre et dÃ©velopper la relation client en magasin ou en entreprise.",
        duration: "3 ans aprÃ¨s la 3e",
        learn: ["Conseiller", "Vendre", "Mettre en rayon", "GÃ©rer un rayon", "Objectifs"],
        jobs: ["Vendeur(se)", "Conseiller(Ã¨re) clientÃ¨le", "EmployÃ©(e) commercial(e)"],
        next: "AprÃ¨s : BTS MCO / NDRC ou insertion pro.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-metiers-du-commerce-et-de-la-vente/",
        mode: "initiale",
        family: "commerce",
      },
  
      // ===== Alternance =====
      alt_commerce: {
        title: "Commerce en alternance",
        badge: "ðŸ” Alternance â€” Commerce",
        pitch: "Suivre une formation commerciale en alternance entre lâ€™Ã©cole et lâ€™entreprise pour apprendre en pratiquant.",
        duration: "Selon contrat",
        learn: ["Vendre en vrai", "Aider les clients", "Missions en magasin"],
        jobs: ["Vendeur(se)", "Assistant(e) commercial(e)", "Conseiller(Ã¨re) clientÃ¨le"],
        next: "CAP / Bac Pro possible selon entreprise.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/metiers-du-commerce-en-alternance/",
        mode: "alternance",
        family: "commerce",
      },
  
      alt_elec: {
        title: "Ã‰lectricitÃ© en alternance",
        badge: "ðŸ” Alternance â€” Ã‰lectricitÃ©",
        pitch: "Apprendre le mÃ©tier dâ€™Ã©lectricien en alternant cours au lycÃ©e et travail dans une entreprise.",
        duration: "Selon contrat",
        learn: ["Installer", "CÃ¢bler", "DÃ©panner", "SÃ©curitÃ©"],
        jobs: ["Ã‰lectricien(ne)", "Technicien(ne)", "Monteur(se)"],
        next: "CAP / Bac Pro possible selon entreprise.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/les-metiers-de-lelectricite/",
        mode: "alternance",
        family: "Ã©lectricitÃ©",
      },
  
      alt_metallerie: {
        title: "MÃ©tallerie en alternance",
        badge: "ðŸ” Alternance â€” MÃ©tallerie",
        pitch: "DÃ©couvrir les mÃ©tiers de la mÃ©tallerie en alternant formation au lycÃ©e et missions en entreprise.",
        duration: "Selon contrat",
        learn: ["DÃ©couper", "Assembler", "Souder", "Poser"],
        jobs: ["MÃ©tallier(Ã¨re)", "Serrurier(Ã¨re)", "Monteur(se)"],
        next: "CAP / Bac Pro possible selon entreprise.",
        pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/les-metiers-de-la-metallerie/",
        mode: "alternance",
        family: "bÃ¢timent",
      },
    };
  
    /* =========================
       2) Texte "C'est quoi l'alternance ?"
       ========================= */
    const ALTERNANCE_EXPLAIN = [
      "ðŸ”„ L'alternance, c'est apprendre un mÃ©tier en travaillant.",
      "",
      "ðŸ‘‰ Une partie du temps au lycÃ©e",
      "ðŸ‘‰ Une partie du temps en entreprise",
      "",
      "âœ… Tu apprends sur le terrain",
      "âœ… Tu gagnes de l'expÃ©rience",
      "âœ… Tu peux Ãªtre rÃ©munÃ©rÃ©(e) selon le contrat",
    ].join("\n");
  
    /* =========================
       3) Mots-clÃ©s (rÃ©ponses)
       ========================= */
    const KEYWORDS = {
      salut: {
        replies: [
          "Salut ðŸ‘‹ Bienvenue au lycÃ©e AimÃ© CÃ©saire !",
          "Bonjour ! Je suis lÃ  pour t'orienter ðŸ˜Š",
          "Hey ! PrÃªt(e) Ã  dÃ©couvrir nos formations ?",
          "Salut ! Je suis le chatbot d'orientation du lycÃ©e.",
        ],
        next: "start",
        isGreeting: true,
      },
      merci: {
        replies: ["Avec plaisir ! ðŸ‘‹", "De rien ! ðŸ˜Š", "Service ! ðŸš€", "ðŸ‘ Bonne continuation !"],
        next: null,
      },
      aurevoir: {
        replies: ["Ã€ bientÃ´t ! ðŸ‘‹", "Salut ! Bonne continuation ðŸš€", "Bye ! ðŸ˜Š", "Bonne journÃ©e !"],
        next: null,
      },
      aide: {
        replies: [
          "ðŸ¤– Dis-moi un domaine : Ã©lectricitÃ©, mÃ©tallerie, commerce, gestion, accueil, alternance.",
          "ðŸ’¡ Exemple : CAP commerce / Bac pro MELEC / alternance Ã©lectricitÃ©.",
        ],
        next: "start",
      },
  
      // Domaines
      electricite: { replies: ["ðŸ”Œ L'Ã©lectricitÃ©, top ! CAP, Bac Pro MELEC ou alternance ?"], next: "elec_choice" },
      metallerie: { replies: ["ðŸ§± MÃ©tallerie : CAP, Bac Pro ou alternance ?"], next: "metal_choice" },
      commerce: { replies: ["ðŸ›ï¸ Commerce : CAP, 2nde MRC, Bac Pro ou alternance ?"], next: "commerce_choice" },
      gestion: { replies: ["ðŸ“ Gestion : 2nde GATL puis Bac Pro AGOrA."], next: "result_bac_agora" },
      accueil: { replies: ["ðŸ™‚ Accueil : Bac Pro MÃ©tiers de lâ€™Accueil."], next: "result_bac_accueil" },
      alternance: { replies: ["ðŸ”„ Alternance : Ã©lectricitÃ©, mÃ©tallerie ou commerce ?"], next: "alternance_choice" },
  
      // CiblÃ©s
      cap_elec: { replies: ["ðŸŽ“ CAP Ã‰lectricien : 2 ans."], next: "result_cap_elec" },
      cap_metal: { replies: ["ðŸŽ“ CAP MÃ©tallier : 2 ans."], next: "result_cap_metallier" },
      cap_commerce: { replies: ["ðŸŽ“ CAP Commerce : 2 ans."], next: "result_cap_epc" },
      bac_elec: { replies: ["ðŸ“ˆ Bac Pro MELEC : 3 ans."], next: "result_bac_melec" },
      bac_metal: { replies: ["ðŸ“ˆ Bac Pro MÃ©tallerie : 3 ans."], next: "result_bac_metallerie" },
      bac_commerce: { replies: ["ðŸ“ˆ Bac Pro Commerce/Vente : 3 ans."], next: "result_bac_commerce" },
    };
  
    /* =========================
       4) FLOW
       ========================= */
    const FLOW = {
      start: {
        bot: [
          "Salut ðŸ‘‹ Je suis le chatbot d'orientation du lycÃ©e AimÃ© CÃ©saire.\nConÃ§u par des Ã©lÃ¨ves, pour les futurs Ã©lÃ¨ves.\n\nDis-moi ce qui t'intÃ©resse : Ã©lectricitÃ©, mÃ©tallerie, commerce, gestion, accueil, alternanceâ€¦",
        ],
        replies: [],
      },
  
      elec_choice: {
        bot: "ðŸ”Œ Ã‰lectricitÃ© : CAP, Bac Pro ou alternance ?",
        replies: [
          { label: "ðŸŽ“ CAP Ã‰lectricien", value: "cap_elec" },
          { label: "ðŸ“ˆ Bac Pro MELEC", value: "bac_melec" },
          { label: "ðŸ”„ Alternance", value: "alt_elec" },
        ],
        next: (ans) => {
          if (ans === "cap_elec") return "result_cap_elec";
          if (ans === "bac_melec") return "result_bac_melec";
          if (ans === "alt_elec") return "result_alt_elec";
          return "start";
        },
      },
  
      metal_choice: {
        bot: "ðŸ§± MÃ©tallerie : CAP, Bac Pro ou alternance ?",
        replies: [
          { label: "ðŸŽ“ CAP MÃ©tallier", value: "cap_metal" },
          { label: "ðŸ“ˆ Bac Pro MÃ©tallerie", value: "bac_metal" },
          { label: "ðŸ”„ Alternance", value: "alt_metal" },
        ],
        next: (ans) => {
          if (ans === "cap_metal") return "result_cap_metallier";
          if (ans === "bac_metal") return "result_bac_metallerie";
          if (ans === "alt_metal") return "result_alt_metallerie";
          return "start";
        },
      },
  
      commerce_choice: {
        bot: "ðŸ›ï¸ Commerce : quelle voie ?",
        replies: [
          { label: "ðŸŽ“ CAP Ã‰quipier Polyvalent", value: "cap_commerce" },
          { label: "ðŸ§­ 2nde MRC (dÃ©couverte)", value: "seconde_mrc" },
          { label: "ðŸ“ˆ Bac Pro Commerce/Vente", value: "bac_commerce" },
          { label: "ðŸ”„ Alternance", value: "alt_commerce" },
        ],
        next: (ans) => {
          if (ans === "cap_commerce") return "result_cap_epc";
          if (ans === "seconde_mrc") return "result_seconde_mrc";
          if (ans === "bac_commerce") return "result_bac_commerce";
          if (ans === "alt_commerce") return "result_alt_commerce";
          return "start";
        },
      },
  
      alternance_choice: {
        bot: "ðŸ”„ Alternance : tu veux quel secteur ?",
        replies: [
          { label: "âš¡ Ã‰lectricitÃ©", value: "alt_elec" },
          { label: "ðŸ§± MÃ©tallerie", value: "alt_metal" },
          { label: "ðŸ›ï¸ Commerce", value: "alt_commerce" },
        ],
        next: (ans) => {
          if (ans === "alt_elec") return "result_alt_elec";
          if (ans === "alt_metal") return "result_alt_metallerie";
          if (ans === "alt_commerce") return "result_alt_commerce";
          return "start";
        },
      },
  
      // ----- RÃ‰SULTATS -----
      result_cap_elec: { result: ["cap_elec"] },
      result_bac_melec: { result: ["bac_melec"] },
      result_cap_metallier: { result: ["cap_metallier"] },
      result_bac_metallerie: { result: ["bac_metallerie"] },
      result_cap_epc: { result: ["cap_epc"] },
      result_seconde_mrc: { result: ["seconde_mrc"] },
      result_bac_commerce: { result: ["bac_commerce"] },
      result_bac_agora: { result: ["bac_agora"] },
      result_bac_accueil: { result: ["bac_accueil"] },
      result_alt_commerce: { result: ["alt_commerce"] },
      result_alt_elec: { result: ["alt_elec"] },
      result_alt_metallerie: { result: ["alt_metallerie"] },
    };
  
    /* =========================
       5) Ã‰tat
       ========================= */
    let state = { nodeId: "start", history: [], intent: null, altInfoShown: false };
    let demoTimer = null;
    let isBotTyping = false;
  
    function nowTime() {
      const d = new Date();
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }
    function scrollToBottom() {
      mainEl.scrollTop = mainEl.scrollHeight;
    }
    function setStatus(text) {
      if (statusChip) statusChip.textContent = text;
    }
  
    /* =========================
       6) UI messages
       ========================= */
    function addMessage({ from, text, html }) {
      const row = document.createElement("div");
      row.className = "row " + (from === "bot" ? "bot" : "user");
  
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      if (html) bubble.innerHTML = html;
      else bubble.textContent = text;
  
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = nowTime();
  
      if (from === "user") {
        row.appendChild(meta);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
        row.appendChild(meta);
      }
  
      messagesEl.appendChild(row);
      scrollToBottom();
    }
  
    function addTyping() {
      const row = document.createElement("div");
      row.className = "row bot";
      row.dataset.typing = "1";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<span class="typing" aria-label="Le bot Ã©crit"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }
    function removeTyping() {
      const t = messagesEl.querySelector('[data-typing="1"]');
      if (t) t.remove();
    }
  
    /* =========================
       7) Typewriter
       ========================= */
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  
    function typewriterMessage(text, { speed = 45, onComplete } = {}) {
      isBotTyping = true;
      setStatus("Ã‰critâ€¦");
      quickRepliesEl.style.display = "none";
  
      const row = document.createElement("div");
      row.className = "row bot";
  
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = "";
  
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = nowTime();
  
      row.appendChild(bubble);
      row.appendChild(meta);
      messagesEl.appendChild(row);
      scrollToBottom();
  
      const safe = escapeHtml(text);
      const parts = safe.split(/(\s+)/);
      let i = 0;
  
      const timer = setInterval(() => {
        bubble.innerHTML += parts[i] ?? "";
        i++;
        scrollToBottom();
        if (i >= parts.length) {
  clearInterval(timer);
  setStatus("PrÃªt");
  quickRepliesEl.style.display = "flex";
  isBotTyping = false;

  // âœ… focus automatique
  const input = document.querySelector(".text-input-container input");
  if (input) input.focus();

  if (onComplete) onComplete();
}
      }, speed);
    }
  
    function botSay(textOrHtml, { html = false, speed = 45, onComplete } = {}) {
      if (html) {
        setStatus("RÃ©pondâ€¦");
        quickRepliesEl.style.display = "none";
        addTyping();
        setTimeout(() => {
          removeTyping();
          addMessage({ from: "bot", html: textOrHtml });
          setStatus("PrÃªt");
          quickRepliesEl.style.display = "flex";
          if (onComplete) onComplete();
        }, 250);
        return;
      }
  
      quickRepliesEl.style.display = "none";
      addTyping();
      setTimeout(() => {
        removeTyping();
        typewriterMessage(textOrHtml, { speed, onComplete });
      }, 220);
    }
  
    function getRandomReply(keyword) {
      const k = KEYWORDS[keyword];
      if (!k || !k.replies || !k.replies.length) return null;
      return k.replies[Math.floor(Math.random() * k.replies.length)];
    }
  
    function getRandomArrayItem(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
  
 /* =========================
   8) Texte libre (avec intent CAP/BAC) + mots proches
   ========================= */
function handleUserInput(inputText) {
  // -------- helpers ----------
  const norm = (s) =>
    (s || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // accents
      .replace(/[^a-z0-9\s'-]/g, " ")
      .replace(/\s+/g, " ")
      .trim();

  const text = norm(inputText);
  if (!text) return null;

  const words = text.split(" ");

  function includesAny(needles) {
    return needles.some((w) => text.includes(w));
  }

  // Distance (Levenshtein) pour "mots proches"
  function levenshtein(a, b) {
    a = norm(a);
    b = norm(b);
    const m = a.length, n = b.length;
    if (!m) return n;
    if (!n) return m;
    const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        dp[i][j] = Math.min(
          dp[i - 1][j] + 1,
          dp[i][j - 1] + 1,
          dp[i - 1][j - 1] + cost
        );
      }
    }
    return dp[m][n];
  }

  // Vrai si un mot est "proche" d'une cible
  function isClose(word, target) {
    word = norm(word);
    target = norm(target);
    if (!word || !target) return false;
    if (word === target) return true;

    // Si le mot est court, on tolÃ¨re 1 faute
    const d = levenshtein(word, target);
    const max = word.length <= 5 || target.length <= 5 ? 1 : 2;

    // bonus : si c'est un dÃ©but de mot (ex: "electr" â†’ "electricite")
    if (target.startsWith(word) && word.length >= 4) return true;

    return d <= max;
  }

  function anyWordClose(targets) {
    return words.some((w) => targets.some((t) => isClose(w, t)));
  }

  // -------- intents base ----------
  if (includesAny(["salut", "bonjour", "hello", "bjr", "slt"])) {
    return { type: "greeting", keyword: "salut" };
  }
  if (includesAny(["merci", "thanks", "thank"])) {
    return { type: "reply", keyword: "merci" };
  }
  if (includesAny(["au revoir", "aurevoir", "bye", "ciao", "a+", "a plus"])) {
    return { type: "reply", keyword: "aurevoir" };
  }
  if (includesAny(["aide", "help"])) {
    return { type: "reply", keyword: "aide" };
  }

  // intent cap/bac (si l'Ã©lÃ¨ve tape juste "cap" ou "bac")
  if (text === "cap") {
    state.intent = "cap";
    return {
      type: "unknown",
      text: "ðŸŽ“ CAP dans quel domaine ?\nâ€¢ Ã‰lectricitÃ©\nâ€¢ MÃ©tallerie\nâ€¢ Commerce",
    };
  }
  if (text === "bac" || text === "bac pro" || text === "bacpro") {
    state.intent = "bac";
    return {
      type: "unknown",
      text: "ðŸ“ˆ Bac Pro dans quel domaine ?\nâ€¢ Ã‰lectricitÃ©\nâ€¢ MÃ©tallerie\nâ€¢ Commerce/Vente\nâ€¢ Gestion\nâ€¢ Accueil",
    };
  }

  // -------- Dictionnaires de synonymes / mÃ©tiers ----------
  const MAP = {
    electricite: [
      "electricite", "electrique", "electro", "elec", "electricien", "electricienne",
      "melec", "domotique", "cablage", "cable", "tableau", "disjoncteur", "prise"
    ],
    metallerie: [
      "metallerie", "metallier", "serrurier", "metal", "metaux", "acier",
      "soudeur", "soudure", "souder", "meulage", "meuler", "chalumeau", "portail"
    ],
    commerce: [
      "commerce", "vente", "vendeur", "vendeuse", "magasin", "rayon",
      "caisse", "encaisser", "client", "clients", "boutique", "stock", "reassort"
    ],
    gestion: [
      "gestion", "administration", "administratif", "administrative", "assistant", "assistante",
      "secretaire", "secretariat", "bureau", "dossier", "classement",
      "transport", "transporteur", "logistique", "livraison", "planning", "facture", "devis", "courrier"
    ],
    accueil: [
      "accueil", "hotesse", "hote", "reception", "receptionniste",
      "standard", "telephone", "rdv", "rendezvous", "orienter", "information"
    ],
    alternance: ["alternance", "apprentissage", "contrat", "cfa"],
  };

  // -------- Si intent posÃ©e (CAP/BAC) : domaine direct mÃªme si faute ----------
  function resolveIntentDomain() {
    if (state.intent === "cap") {
      if (anyWordClose(MAP.commerce)) { state.intent = null; return { type: "flow", keyword: "cap_commerce" }; }
      if (anyWordClose(MAP.electricite)) { state.intent = null; return { type: "flow", keyword: "cap_elec" }; }
      if (anyWordClose(MAP.metallerie)) { state.intent = null; return { type: "flow", keyword: "cap_metal" }; }
    }
    if (state.intent === "bac") {
      if (anyWordClose(MAP.commerce)) { state.intent = null; return { type: "flow", keyword: "bac_commerce" }; }
      if (anyWordClose(MAP.electricite)) { state.intent = null; return { type: "flow", keyword: "bac_elec" }; }
      if (anyWordClose(MAP.metallerie)) { state.intent = null; return { type: "flow", keyword: "bac_metal" }; }
      if (anyWordClose(MAP.gestion)) { state.intent = null; return { type: "flow", keyword: "gestion" }; }
      if (anyWordClose(MAP.accueil)) { state.intent = null; return { type: "flow", keyword: "accueil" }; }
    }
    return null;
  }
  const intentHit = resolveIntentDomain();
  if (intentHit) return intentHit;

  // -------- Phrases directes CAP/BAC (avec fautes possibles) ----------
  const hasCap = anyWordClose(["cap"]);
  const hasBac = anyWordClose(["bac", "bacpro", "bac-pro", "bacpro."]) || text.includes("bac pro");

  if (hasCap && anyWordClose(MAP.commerce)) return { type: "flow", keyword: "cap_commerce" };
  if (hasCap && anyWordClose(MAP.electricite)) return { type: "flow", keyword: "cap_elec" };
  if (hasCap && anyWordClose(MAP.metallerie)) return { type: "flow", keyword: "cap_metal" };

  if (hasBac && anyWordClose(MAP.commerce)) return { type: "flow", keyword: "bac_commerce" };
  if (hasBac && anyWordClose(MAP.electricite)) return { type: "flow", keyword: "bac_elec" };
  if (hasBac && anyWordClose(MAP.metallerie)) return { type: "flow", keyword: "bac_metal" };
  if (hasBac && anyWordClose(MAP.gestion)) return { type: "flow", keyword: "gestion" };
  if (hasBac && anyWordClose(MAP.accueil)) return { type: "flow", keyword: "accueil" };

  // -------- Domaines gÃ©nÃ©raux (si on tape un mÃ©tier) ----------
  if (anyWordClose(MAP.electricite)) return { type: "flow", keyword: "electricite" };
  if (anyWordClose(MAP.metallerie)) return { type: "flow", keyword: "metallerie" };
  if (anyWordClose(MAP.commerce)) return { type: "flow", keyword: "commerce" };
  if (anyWordClose(MAP.gestion)) return { type: "flow", keyword: "gestion" };
  if (anyWordClose(MAP.accueil)) return { type: "flow", keyword: "accueil" };
  if (anyWordClose(MAP.alternance)) return { type: "flow", keyword: "alternance" };

  // -------- CAP ou BAC sans domaine (mais fautes possibles) ----------
  if (hasCap && !hasBac) {
    state.intent = "cap";
    return {
      type: "unknown",
      text: "ðŸŽ“ CAP dans quel domaine ?\nâ€¢ Ã‰lectricitÃ©\nâ€¢ MÃ©tallerie\nâ€¢ Commerce",
    };
  }
  if (hasBac && !hasCap) {
    state.intent = "bac";
    return {
      type: "unknown",
      text: "ðŸ“ˆ Bac Pro dans quel domaine ?\nâ€¢ Ã‰lectricitÃ©\nâ€¢ MÃ©tallerie\nâ€¢ Commerce/Vente\nâ€¢ Gestion\nâ€¢ Accueil",
    };
  }

  // fallback
  return {
    type: "unknown",
    text: "ðŸ¤” Je n'ai pas bien compris.\nEssaie :\nâ€¢ CAP commerce\nâ€¢ Bac pro MELEC\nâ€¢ Soudeur\nâ€¢ SecrÃ©taire\nâ€¢ Alternance\nâ€¢ Ã‰lectricitÃ©\nâ€¢ Gestion\nâ€¢ Accueil",
  };
}
    /* =========================
       9) Quick replies
       ========================= */
    function setReplies(replies) {
      quickRepliesEl.innerHTML = "";
  
      (replies || []).forEach((r, idx) => {
        const b = document.createElement("button");
        b.className = "qr " + (idx === 0 ? "accent" : idx === 1 ? "good" : "");
        b.textContent = r.label;
        b.onclick = () => onUserAnswer(r);
        quickRepliesEl.appendChild(b);
      });
  
      // bouton alternance : une seule fois aprÃ¨s un rÃ©sultat alternance
      const nodeId = state.nodeId;
      if (nodeId.startsWith("result_alt_") && !state.altInfoShown) {
        const alt = document.createElement("button");
        alt.className = "qr";
        alt.textContent = "â„¹ï¸ C'est quoi l'alternance ?";
        alt.onclick = () => {
          state.altInfoShown = true;
          alt.remove();
          showAlternanceInfo();
        };
        quickRepliesEl.appendChild(alt);
      }
    }
  
    /* =========================
       10) Cartes rÃ©sultats
       ========================= */
    function renderResultCards(keys) {
      const cards = keys
        .map((k) => {
          const p = PROGRAMS[k];
          if (!p) return "";
  
          const jobs = (p.jobs || []).map((j) => `â€¢ ${escapeHtml(j)}`).join("<br>");
          const learn = (p.learn || []).map((l) => `â€¢ ${escapeHtml(l)}`).join("<br>");
  
          return `
            <div class="card">
              ${p.badge ? `<div class="badge">${escapeHtml(p.badge)}</div>` : ""}
              <h3>${escapeHtml(p.title)}</h3>
              <p>${escapeHtml(p.pitch)}</p>
              ${p.duration ? `<p><strong>DurÃ©e :</strong> ${escapeHtml(p.duration)}</p>` : ""}
              ${learn ? `<p><strong>Tu apprendras Ã  :</strong><br>${learn}</p>` : ""}
              <p><strong>Exemples de mÃ©tiers :</strong><br>${jobs}</p>
              <p>${escapeHtml(p.next || "")}</p>
              ${
                p.pageUrl
                  ? `<div class="actions">
                      <a class="link" href="${p.pageUrl}" target="_blank" rel="noopener">ðŸ“„ Pour plus d'informations...</a>
                    </div>`
                  : ""
              }
            </div>
          `;
        })
        .join("");
  
      return `
        <div>
          <div style="margin-bottom:10px; font-weight:800;">Voici ce que je te propose ðŸ‘‡</div>
          <div class="cards">${cards}</div>
        </div>
      `;
    }
  
    /* =========================
       11) Navigation
       ========================= */
    function goTo(nodeId) {
      state.nodeId = nodeId;
      const node = FLOW[nodeId];
      if (!node) return;
  
      // reset alternance explain button when leaving/entering results (simple)
      if (!nodeId.startsWith("result_alt_")) state.altInfoShown = false;
  
      if (node.result) {
        botSay("Je rÃ©flÃ©chis Ã  la meilleure formation pour toiâ€¦", {
          speed: 40,
          onComplete: () => {
            const html = renderResultCards(node.result);
            botSay(html, {
              html: true,
              onComplete: () => {
                setReplies([{ label: "ðŸ” Refaire le test", value: "__restart__" }]);
              },
            });
          },
        });
        return;
      }
  
      const botMessage = Array.isArray(node.bot) ? getRandomArrayItem(node.bot) : node.bot;
      botSay(botMessage, {
        speed: 45,
        onComplete: () => setReplies(node.replies || []),
      });
    }
  
    /* =========================
       12) RÃ©ponses utilisateur
       ========================= */
       function onUserAnswer(reply) {
  quickRepliesEl.style.display = "none";

  // âœ… Restart
  if (reply.value === "__restart__") {
    restartFlow();
    return;
  }

  // âœ… Bouton normal (quick reply)
  if (reply.value && !reply.isText) {
    addMessage({ from: "user", text: reply.label });

    const current = FLOW[state.nodeId];
    const nextId = typeof current.next === "function"
      ? current.next(reply.value)
      : current.next;

    goTo(nextId || "start");
    return;
  }

  // âœ… Texte libre
  if (reply.isText) {
    addMessage({ from: "user", text: reply.label });

    const result = handleUserInput(reply.label);
    if (!result) return;

    // Greeting
    if (result.type === "greeting") {
      const t = getRandomReply("salut");
      botSay(t || "Salut !", { speed: 45, onComplete: () => goTo("start") });
      return;
    }

    // Simple reply
    if (result.type === "reply") {
      const t = getRandomReply(result.keyword);
      botSay(t || "OK !", { speed: 45 });
      return;
    }

    // Flow navigation
    if (result.type === "flow") {
      let nextNode = "start";

      // Menus
      if (result.keyword === "electricite") nextNode = "elec_choice";
      if (result.keyword === "metallerie") nextNode = "metal_choice";
      if (result.keyword === "commerce") nextNode = "commerce_choice";
      if (result.keyword === "alternance") nextNode = "alternance_choice";

      // RÃ©sultats directs
      if (result.keyword === "gestion") nextNode = "result_bac_agora";
      if (result.keyword === "accueil") nextNode = "result_bac_accueil";

      if (result.keyword === "cap_elec") nextNode = "result_cap_elec";
      if (result.keyword === "cap_metal") nextNode = "result_cap_metallier";
      if (result.keyword === "cap_commerce") nextNode = "result_cap_epc";

      if (result.keyword === "bac_elec") nextNode = "result_bac_melec";
      if (result.keyword === "bac_metal") nextNode = "result_bac_metallerie";
      if (result.keyword === "bac_commerce") nextNode = "result_bac_commerce";

      // âœ… Si on va vers un menu, on va direct (sinon doublon)
      const isMenu = ["elec_choice", "metal_choice", "commerce_choice", "alternance_choice"].includes(nextNode);

      if (isMenu) {
        goTo(nextNode);
        return;
      }

      // âœ… Sinon, rÃ©sultat direct : on garde la phrase + carte
      const t = getRandomReply(result.keyword) || "OK ðŸ‘";
      botSay(t, { speed: 45, onComplete: () => goTo(nextNode) });
      return;
    }

    // Unknown
    botSay(result.text, { speed: 45 });
  }
}
    /* =========================
       13) Alternance info
       ========================= */
    function showAlternanceInfo() {
      quickRepliesEl.style.display = "none";
      addMessage({ from: "user", text: "â„¹ï¸ C'est quoi l'alternance ?" });
      botSay(ALTERNANCE_EXPLAIN, {
        onComplete: () => setReplies([{ label: "ðŸ” Refaire le test", value: "__restart__" }]),
      });
    }
  
    /* =========================
       14) Restart + Intro
       ========================= */
    function restartFlow() {
      stopDemo();
      messagesEl.innerHTML = "";
      quickRepliesEl.style.display = "none";
      state = { nodeId: "start", history: [], intent: null, altInfoShown: false };
      setStatus("PrÃªt");
  
      const startMsg = getRandomArrayItem(FLOW.start.bot);
      botSay(startMsg, {
        speed: 45,
        onComplete: () => (quickRepliesEl.innerHTML = ""),
      });
    }
  
    function intro() {
      quickRepliesEl.style.display = "none";
      setTimeout(restartFlow, 200);
    }
  
    /* =========================
       15) Input texte libre
       ========================= */
    function addTextInput() {
      if (document.querySelector(".text-input-container")) return;
  
      const host = document.getElementById("composerHost");
      if (!host) return;
  
      const container = document.createElement("div");
      container.className = "text-input-container";
  
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Ã‰cris iciâ€¦ (ex: CAP commerce, Bac pro MELEC)";
      input.autocomplete = "off";
      input.spellcheck = false;
  
      const sendBtn = document.createElement("button");
      sendBtn.type = "button";
      sendBtn.textContent = "Envoyer";
  
      function send() {
  if (isBotTyping) return; // ðŸš« bloque pendant Ã©criture

  const v = input.value.trim();
  if (!v) return;

  onUserAnswer({ label: v, value: null, isText: true });
  input.value = "";

  setTimeout(() => {
    input.blur();
  }, 50);
}
      sendBtn.onclick = send;
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          send();
        }
      });
  
      container.appendChild(input);
      container.appendChild(sendBtn);
      host.appendChild(container);
    }
  
    /* =========================
       16) DÃ©mo (optionnel)
       ========================= */
    function startDemo() {
      stopDemo();
      if (btnDemo) {
        btnDemo.textContent = "â¸ Stop dÃ©mo";
        btnDemo.dataset.on = "1";
      }
      restartFlow();
    }
  
    function stopDemo() {
      if (demoTimer) clearTimeout(demoTimer);
      demoTimer = null;
      if (btnDemo) btnDemo.removeAttribute("data-on");
    }
  
    btnRestart?.addEventListener("click", restartFlow);
    btnDemo?.addEventListener("click", () => {
      if (btnDemo.dataset.on) stopDemo();
      else startDemo();
    });
  
    /* =========================
       17) Lancement
       ========================= */
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => {
        intro();
        setTimeout(addTextInput, 150);
      });
    } else {
      intro();
      setTimeout(addTextInput, 150);
    }
  </script>
</body>

</html>